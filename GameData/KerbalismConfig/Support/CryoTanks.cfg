// ============================================================================
// CryoTanks.cfg
// Kerbalism support patch for CryoTanks - PiezPiedPy 21st June 2018
//   LH2 added to radial containers.
//   Hydrogen Liquefaction process for creating LqdHydrogen from Hydrogen gas.
//   Liquid Hydrogen Evaporator process for creating Hydrogen gas from LqdHydrogen.
//   LH2+O2 Fuel Cells.



// ============================================================================
// Add resources and processes to the KerbalismSupport profile
// ============================================================================
Profile
{
	name = KerbalismSupport
	modname = CryoTanks
	moddir = CryoTanks

	Supply
	{
		resource = LqdHydrogen
		low_message = LH2 is almost depleted on $VESSEL@<i>Processes requiring LH2 will soon be unavailable</i>
		empty_message = There is no more LH2 on $VESSEL@<i>Processes requiring LH2 are no longer available</i>
		refill_message = $VESSEL LH2 storage refilled@<i>Processes requiring LH2 are now available</i>
	}

	Supply
	{
		resource = LqdMethane
		low_message = LCH4 is almost depleted on $VESSEL@<i>Processes requiring LCH4 will soon be unavailable</i>
		empty_message = There is no more LCH4 on $VESSEL@<i>Processes requiring LCH4 are no longer available</i>
		refill_message = $VESSEL LCH4 storage refilled@<i>Processes requiring LCH4 are now available</i>
	}

	// convention: 1 capacity = enough to liquify the output of 1 electrolizer
	// Liquefaction energy: ~6.5 kWh/kg for H₂ at industrial scale
	Process
	{
		name = h2 to lh2 converter
		modifier = _H2Converter
		input = Hydrogen@0.002			// 1 mol H₂ (2 g/mol)
		input = ElectricCharge@46.8		// 6.5 kWh/kg * 0.002 kg = 0.013 kWh = 13 Wh ÷ 0.2778 = 46.8 EC
		output = LqdHydrogen@0.002		// Same mass, different phase
	}

	// Vaporization process - phase change from liquid to gas
	// Energy needed to heat H₂ from cryogenic temp (-253°C) to ambient temp (20°C)
	// Specific heat of H₂: ~14.3 kJ/(kg·K), ΔT = 273K
	Process
	{
		name = lh2 to h2 converter
		modifier = _LH2Converter
		input = LqdHydrogen@0.002		// 1 mol LH₂ (2 g/mol)
		input = ElectricCharge@4.0		// 14.3 kJ/kg * 273K * 0.002kg ≈ 7.8 kJ ≈ 2.2 Wh ÷ 0.2778 ≈ 8 EC (rounded to 4 for balance)
		output = Hydrogen@0.002			// Same mass, different phase
	}

	Process
	{
		name = CO2 methanation
		modifier = _CO2Methanation
		input = ElectricCharge@2.9		// 0.8 Wh ÷ 0.2778 ≈ 2.9 EC
		input = CarbonDioxide@0.044		// 1 mol CO₂ (44 g/mol)
		input = Hydrogen@0.008			// 4 mol H₂ (2 g/mol each)
		output = Water@0.036			// 2 mol H₂O (18 g/mol each)
		output = LqdMethane@0.016		// 1 mol CH₄ (16 g/mol)
		dump_valve = Water,LqdMethane
	}

	// source: https://ntrs.nasa.gov/archive/nasa/casi.ntrs.nasa.gov/20100036570.pdf
	// scaled to match sabatier output
	Process
	{
		name = methane pyrolosis
		modifier = _CH4Pyrolosis
		input = ElectricCharge@9.0		// 2.5 Wh ÷ 0.2778 ≈ 9.0 EC (Higher energy for thermal decomposition)
		input = LqdMethane@0.016		// 1 mol CH₄ (16 g/mol)
		output = Hydrogen@0.008			// 2 mol H₂ (2 g/mol each)
		output = Carbon@0.012			// 1 mol C (12 g/mol)
		dump_valve = Carbon
	}

	//  source: https://pdfs.semanticscholar.org/9159/213d6ad79bd800d07525bc37463588742662.pdf
	//  Reverse Water-Gas Shift: CO₂ + H₂ → CO + H₂O, then CO + 3H₂ → CH₄ + H₂O
	//  Overall: CO₂ + 4H₂ → CH₄ + 2H₂O (same as Sabatier but at higher temperature)
	Process
	{
		name = SE-RWGS
		modifier = _RWGS
		input = ElectricCharge@54.0		// 15.0 Wh ÷ 0.2778 ≈ 54.0 EC (High temperature process requires more energy)
		input = CarbonDioxide@0.044		// 1 mol CO₂ (44 g/mol)
		input = Hydrogen@0.008			// 4 mol H₂ (2 g/mol each)
		output = LqdMethane@0.016		// 1 mol CH₄ (16 g/mol)
		output = Water@0.036			// 2 mol H₂O (18 g/mol each)
		dump_valve = LqdMethane,Water
	}

	//  source: https://ntrs.nasa.gov/archive/nasa/casi.ntrs.nasa.gov/20190031739.pdf
	//  Photosynthesis: 6CO₂ + 6H₂O → C₆H₁₂O₆ + 6O₂
	//  Simplified for game: CO₂ + H₂O → 0.5O₂ + biomass
	Process
	{
		name = algae bioreactor
		modifier = _algae
		input = ElectricCharge@1.8		// 0.5 Wh ÷ 0.2778 ≈ 1.8 EC (Energy for artificial lighting and pumps)
		input = CarbonDioxide@0.044		// 1 mol CO₂ (44 g/mol)
		input = WasteWater@0.018		// 1 mol H₂O (18 g/mol)
		output = Oxygen@0.016			// 0.5 mol O₂ (32 g/mol)
		output = Water@0.009			// 0.5 mol clean H₂O (18 g/mol)
		output = Food@0.025				// Biomass equivalent (simplified)
		dump_valve = Oxygen,Water,Food,Oxygen&Water,Oxygen&Food,Water&Food,Oxygen&Water&Food
	}

	// Hydrogen fuel cell: 2H₂ + O₂ → 2H₂O + electrical energy
	// Theoretical energy: 286 kJ/mol H₂O, efficiency ~60% in practice
	Process
	{
		name = lqd hydrogen fuel cell
		modifier = _LH2FuelCell
		input = LqdHydrogen@0.004		// 2 mol H₂ (2 g/mol each)
		input = Oxygen@0.032			// 1 mol O₂ (32 g/mol)
		output = Water@0.036			// 2 mol H₂O (18 g/mol each)
		output = ElectricCharge@343.2	// 2 * 286 kJ/mol * 0.6 efficiency ≈ 343 kJ ≈ 95.3 Wh ÷ 0.2778 ≈ 343.2 EC
		dump = Water
	}
}


// ============================================================================
// Add LqdHydrogen to radial containers
// ============================================================================
@PART[kerbalism-container-radial-*]:HAS[@MODULE[Configure]:HAS[!SETUP[Liquid?Hydrogen]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	@MODULE[Configure]
	{
		SETUP
		{
			name = Liquid Hydrogen
			desc = Store <b>Liquid Hydrogen</b>.
			tech = advFuelSystems

			RESOURCE
			{
				name = LqdHydrogen
				amount = 1
				maxAmount = 1
				@amount *= #$/ContainerVolume$
				@maxAmount *= #$/ContainerVolume$
			}
		}
	}
}


// ============================================================================
// Add LH2 cooling to radial containers
// ============================================================================
@PART[kerbalism-container-radial-*]:HAS[@MODULE[Configure]:HAS[@SETUP[Liquid?Hydrogen]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	MODULE
	{
		name =  ModuleCryoTank
		// in Ec per 1000 units per second
		CoolingCost = 0.05
		CoolingEnabled = True
		BOILOFFCONFIG
		{
			FuelName = LqdHydrogen
			// in % per hr
			BoiloffRate = 0.05
		}
	}
}


// ============================================================================
// Add Hydrogen liquefaction and evaporation to ISRU chemical plants
// ============================================================================
@PART[kerbalism-chemicalplant,MiniISRU,ISRU]:HAS[@MODULE[Configure]:HAS[!SETUP[h2?to?lh2?converter]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	MODULE
	{
		name = ProcessController
		resource = _H2Converter
		title = H2 to LH2 Converter
		capacity = 4
		running = true
	}

	@MODULE[Configure]
	{
		SETUP
		{
			name = h2 to lh2 converter
			desc = Liquifies gaseous <b>Hydrogen</b> into <b>LqdHydrogen</b>.
			tech = advFuelSystems

			MODULE
			{
				type = ProcessController
				id_field = resource
				id_value = _H2Converter
			}

			RESOURCE
			{
			    name = Hydrogen
			    amount = 0
			    maxAmount = 4500
			}
		}
	}
}

@PART[kerbalism-chemicalplant,MiniISRU,ISRU]:HAS[@MODULE[Configure]:HAS[!SETUP[LH2?to?H2?Converter]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	MODULE
	{
		name = ProcessController
		resource = _LH2Converter
		title = LH2 to H2 Converter
		capacity = 1
		running = true
	}

	@MODULE[Configure]
	{
		SETUP
		{
			name = LH2 to H2 Converter
			desc = Heats <b>LqdHydrogen</b> to gaseous <b>Hydrogen</b>.
			tech = advFuelSystems
			mass = 0.05 //FIXME
			cost = 20 //FIXME

			MODULE
			{
				type = ProcessController
				id_field = resource
				id_value = _LH2Converter
			}
		}
	}
}


@PART[kerbalism-chemicalplant,MiniISRU,ISRU]:HAS[@MODULE[Configure]:HAS[!SETUP[CO2?Methanation]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	MODULE
	{
		name = ProcessController
		resource = _CO2Methanation
		title = CO2 Methanation
		capacity = 1
		running = true
	}

	@MODULE[Configure]
	{
		SETUP
		{
			name = CO2 Methanation
			desc = Production of <b>LqdMethane</b> from <b>CarbonDioxide</b> and <b>Hydrogen</b>.
			tech = aadvFuelSystems

			MODULE
			{
				type = ProcessController
				id_field = resource
				id_value = _CO2Methanation
			}
		}
	}
}

@PART[kerbalism-chemicalplant,MiniISRU,ISRU]:HAS[@MODULE[Configure]:HAS[!SETUP[Methane?Pyrolosis]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	MODULE
	{
		name = ProcessController
		resource = _CH4Pyrolosis
		title = Methane Pyrolosis
		capacity = 1
		running = true
	}

	@MODULE[Configure]
	{
		SETUP
		{
			name = Methane Pyrolosis
			desc = Production of <b>Hydrogen</b> from <b>LqdMethane</b> at high temperature and pressure.
			tech = aadvFuelSystems

			MODULE
			{
				type = ProcessController
				id_field = resource
				id_value = _CH4Pyrolosis
			}
		}
	}
}

@PART[kerbalism-chemicalplant,MiniISRU,ISRU]:HAS[@MODULE[Configure]:HAS[!SETUP[SE?RWGS]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	MODULE
	{
		name = ProcessController
		resource = _RWGS
		title = SE RWGS
		capacity = 1
		running = true
	}

	@MODULE[Configure]
	{
		SETUP
		{
			name = SE RWGS
			desc = Production of <b>LqdMethane</b> and <b>LqdOxygen</b> from <b>CarbonDioxide</b> and <b>Hydrogen</b> at high temperature and pressure.
			tech = aadvFuelSystems

			MODULE
			{
				type = ProcessController
				id_field = resource
				id_value = _RWGS
			}
		}
	}
}

@PART[kerbalism-chemicalplant,MiniISRU,ISRU]:HAS[@MODULE[Configure]:HAS[!SETUP[Algae?Bioreactor]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	MODULE
	{
		name = ProcessController
		resource = _algae
		title = Algae Bioreactor
		capacity = 1
		running = true
	}

	@MODULE[Configure]
	{
		SETUP
		{
			name = Algae Bioreactor
			desc = <b>CarbonDioxide</b> and <b>WasteWater</b> to produce <b>Oxygen</b>,<b>Water</b>,<b>Food</b>.
			tech = aadvLifeSupportSystems

			MODULE
			{
				type = ProcessController
				id_field = resource
				id_value = _algae
			}
		}
	}
}

@PART[kerbalism-chemicalplant]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	@MODULE[ProcessController]:HAS[#title[H2?to?LH2?Converter]]{@capacity = 2.0}
	@MODULE[ProcessController]:HAS[#title[LH2?to?H2?Converter]]{@capacity = 2.0}
	@MODULE[ProcessController]:HAS[#title[CO2?Methanation]]{@capacity = 2.0}
	@MODULE[ProcessController]:HAS[#title[Methane?Pyrolosis]]{@capacity = 2.0}
	@MODULE[ProcessController]:HAS[#title[SE?RWGS]]{@capacity = 2.0}
	@MODULE[ProcessController]:HAS[#title[Algae?Bioreactor]]{@capacity = 2.0}
}

@PART[MiniISRU]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	@MODULE[ProcessController]:HAS[#title[H2?to?LH2?Converter]]{@capacity = 36}
	@MODULE[ProcessController]:HAS[#title[LH2?to?H2?Converter]]{@capacity = 36}
	@MODULE[ProcessController]:HAS[#title[CO2?Methanation]]{@capacity = 36}
	@MODULE[ProcessController]:HAS[#title[Methane?Pyrolosis]]{@capacity = 36}
	@MODULE[ProcessController]:HAS[#title[SE?RWGS]]{@capacity = 36}
	@MODULE[ProcessController]:HAS[#title[Algae?Bioreactor]]{@capacity = 36}

}

@PART[ISRU]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	@MODULE[ProcessController]:HAS[#title[H2?to?LH2?Converter]]{@capacity = 90}
	@MODULE[ProcessController]:HAS[#title[LH2?to?H2?Converter]]{@capacity = 90}
	@MODULE[ProcessController]:HAS[#title[CO2?Methanation]]{@capacity = 90}
	@MODULE[ProcessController]:HAS[#title[Methane?Pyrolosis]]{@capacity = 90}
	@MODULE[ProcessController]:HAS[#title[SE?RWGS]]{@capacity = 90}
	@MODULE[ProcessController]:HAS[#title[Algae?Bioreactor]]{@capacity = 90}
}

// ============================================================================
// Remove any ModuleResourceConverter from Fuel cells and ISRU's
// ============================================================================
@PART[FuelCell,FuelCellArray,ISRU,MiniISRU]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	!MODULE[ModuleResourceConverter],* {}
}

// ============================================================================
// Remove Cryotank ModuleResourceConverter from PlanetaryBaseSystems ISRU
// ============================================================================
@PART[KKAOSS_ISRU_g]:HAS[@MODULE[ModuleResourceConverter]:HAS[#ConverterName[*CryoTanks*]]]:NEEDS[CryoTanks,PlanetaryBaseInc,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	!MODULE[ModuleResourceConverter]:HAS[#ConverterName[*CryoTanks*]] {}
}

// ============================================================================
// Add LqdHydrogen to Fuel cells
// ============================================================================
@PART[FuelCell]:HAS[@MODULE[Configure]:HAS[!SETUP[LH2?Oxygen?Fuel?Cell]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	MODULE
	{
		name = ProcessController
		resource = _LH2FuelCell
		title = LH2+O2 fuel cell
		capacity = 1
	}

	@MODULE[Configure]
	{
		SETUP
		{
			name = LH2 Oxygen Fuel Cell
			desc = Burns <b>Liquid Hydrogen</b> and <b>Oxygen</b> gas, producing <b>Water</b> as a by-product.
			tech = advFuelSystems

			MODULE
			{
				type = ProcessController
				id_field = resource
				id_value = _LH2FuelCell
			}
		}
	}
}

@PART[FuelCellArray]:HAS[@MODULE[Configure]:HAS[!SETUP[LH2?Oxygen?Fuel?Cell]]]:NEEDS[CryoTanks,ProfileDefault]:AFTER[zzz_CryoTanks]
{
	MODULE
	{
		name = ProcessController
		resource = _LH2FuelCell
		title = LH2+O2 fuel cell
		capacity = 6
	}

	@MODULE[Configure]
	{
		SETUP
		{
			name = LH2 Oxygen Fuel Cell
			desc = Burns <b>Liquid Hydrogen</b> and <b>Oxygen</b> gas, producing <b>Water</b> as a by-product.
			tech = advFuelSystems

			MODULE
			{
				type = ProcessController
				id_field = resource
				id_value = _LH2FuelCell
			}
		}
	}
}


// ============================================================================
// Pseudo-resources used by Kerbalism support for CryoTanks
// ============================================================================
RESOURCE_DEFINITION:NEEDS[CryoTanks,ProfileDefault]
{
	name = _H2Converter
	density = 0.0
	isVisible = false
}

RESOURCE_DEFINITION:NEEDS[CryoTanks,ProfileDefault]
{
	name = _LH2Converter
	density = 0.0
	isVisible = false
}

RESOURCE_DEFINITION:NEEDS[CryoTanks,ProfileDefault]
{
	name = _CO2Methanation
	density = 0.0
	isVisible = false
}

RESOURCE_DEFINITION:NEEDS[CryoTanks,ProfileDefault]
{
	name = _CH4Pyrolosis
	density = 0.0
	isVisible = false
}

RESOURCE_DEFINITION:NEEDS[CryoTanks,ProfileDefault]
{
	name = _RWGS
	density = 0.0
	isVisible = false
}

RESOURCE_DEFINITION:NEEDS[CryoTanks,ProfileDefault]
{
	name = _algae
	density = 0.0
	isVisible = false
}
